name: TestFlow

on: 
  workflow_dispatch:

jobs: 
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [ubuntu-latest]
        version: [9.0]
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v5.0.0
        with:
          dotnet-version: ${{ matrix.version}}

      - name: Checkout
        uses: actions/checkout@v5

      - name: Build Solution
        run: dotnet build

      - name: Run tests
        id: test
        run: |
          dotnet test --no-restore --logger "console;verbosity=normal" > testlog.txt || true
          PASSED=$(awk '/Passed:/ {print $2}' testlog.txt)
          FAILED=$(awk '/Failed:/ {print $2}' testlog.txt)
          FAILED=${FAILED:-0}   # default to 0 if empty

          
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          
        env:
          USE_SQLITE: "true"

      - name: Notify Discord with test result
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -X POST \
               -H "Content-Type: application/json" \
               -d "{\"content\": \"üß™ Tester k√∂rda!\n‚úÖ Passed: ${{ steps.test.outputs.passed }}\n‚ùå Failed: ${{ steps.test.outputs.failed }}\"}" \
               "$DISCORD_WEBHOOK_URL"
